---
title: "DATA608 - Story 3"
author: "Glen Dale Davis"
date: "2023-09-25"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Setup:

```{r packages, warning=FALSE, message=FALSE}
library(geojsonio)
library(mapproj)
library(maptools)
library(RColorBrewer)
library(rgeos)
library(rgdal)
library(shiny)
library(tidyverse)
library(viridis)

```

## Data:

```{r data}
#Geojson File Source: https://team.carto.com/u/andrew/tables/andrew.us_states_hexgrid/public/map
my_url <- "https://raw.githubusercontent.com/geedoubledee/Story3/main/us_states_hexgrid.geojson"
geo_df <- geojson_read(my_url,  what = "sp")
geo_df@data <- geo_df@data |>
    mutate(google_name = gsub(" \\(United States\\)", "", google_name))

#Marriage & population data for temporary usage - replace
temp_data1 <- read.table("https://raw.githubusercontent.com/holtzy/R-graph-gallery/master/DATA/State_mariage_rate.csv", header=T, sep=",", na.strings="---")

# Fortify
geo_fort <- fortify(geo_df, region="google_name")
geo_fort <- geo_fort |>
  left_join(temp_data1, by = c("id" = "state"))

# Calculate hexagon centers for labeling purposes:
centers <- cbind.data.frame(data.frame(gCentroid(geo_df, byid = TRUE),
                                       id = geo_df@data$iso3166_2))

# Bin data
geo_fort$bin <- cut(geo_fort$y_2015 , breaks=c(seq(5,10), Inf),
                   labels=c("5-6", "6-7", "7-8", "8-9", "9-10", "10+"),
                   include.lowest = TRUE)
 
# Prepare palette from viridis
my_palette <- rev(magma(8))[c(-1,-8)]
 
# Plot the shape
p <- ggplot() +
    geom_polygon(data = geo_fort, aes(fill = bin, x = long, y = lat,
                                      group = group),
                 linewidth = 0, alpha = 0.9) +
    geom_text(data = centers, aes(x = x, y = y, label = id), color="white",
              size = 3, alpha = 0.6) +
    scale_fill_manual(values = my_palette,
                      name = "Wedding per 1000 people in 2015",
                      guide = guide_legend(keyheight = unit(3, units = "mm"),
                                           keywidth = unit(12, units = "mm"),
                                           label.position = "bottom",
                                           title.position = 'top', nrow=1)) +
    labs(title = "A map of marriage rates, state by state") +
    theme_void() +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "bottom") +
    coord_map()
p

```

## App:

```{r app}
runApp("my_app", display.mode = "showcase")

```
